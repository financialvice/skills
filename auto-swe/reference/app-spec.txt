<project_specification>
  <project_name>Claude.ai Clone - AI Chat Interface</project_name>

  <overview>
    Build a fully functional clone of claude.ai, Anthropic's conversational AI interface. The application should
    provide a clean, modern chat interface for interacting with Claude via the API, including features like
    conversation management, artifact rendering, project organization, multiple model selection, and advanced
    settings. The UI should closely match claude.ai's design using Tailwind CSS with a focus on excellent
    user experience and responsive design.
  </overview>

  <technology_stack>
    <api_keys>
        API_KEYS will be populated in the root .env and in relevant apps/*. You can read and write the .env file.
    </api_keys>
    <frontend>
      <framework>React with NextJS 16</framework>
      <styling>Tailwind CSS v4</styling>
      <state_management>InstantDB frontend database (majority of state), zustand for local-only / ephemeral state</state_management>
      <realtime>InstantDB presence</realtime>
      <database>InstantDB</database>
      <routing>NextJS</routing>
      <markdown>React Markdown for message rendering</markdown>
      <code_highlighting>Syntax highlighting for code blocks</code_highlighting>
      <port>Only launch on port {frontendPort}</port>
    </frontend>
    <backend>
      <runtime>Bun, NextJS /api routes</runtime>
      <database>InstantDB (prefer frontend usage, only use on backend in conjunction with external services or special circumstances)</database>
      <api_integration>Claude API for chat completions, use tRPC for end-to-end type-safety</api_integration>
      <tasks>Trigger.dev for long-running tasks (LLM calls, Agents, etc.), scheduled tasks, and crons</tasks>
      <streaming>Trigger.dev streaming</streaming>
    </backend>
    <communication>
      <claude_api>Integration with Claude API using Anthropic SDK</claude_api>
    </communication>
  </technology_stack>

  <prerequisites>
    <environment_setup>
      - Repository includes .env with {envKeys} configured
      - Dependencies pre-installed via bun
      - Backend code goes in /trpc, /api directories
    </environment_setup>
  </prerequisites>

  <core_features>
    <chat_interface>
      - Clean, centered chat layout with message bubbles
      - Streaming message responses with typing indicator
      - Markdown rendering with proper formatting
      - Code blocks with syntax highlighting and copy button
      - LaTeX/math equation rendering
      - Image upload and display in messages
      - Multi-turn conversations with context
      - Message editing and regeneration
      - Stop generation button during streaming
      - Input field with auto-resize textarea
      - Character count and token estimation
      - Keyboard shortcuts (Enter to send, Shift+Enter for newline)
    </chat_interface>

    <artifacts>
      - Artifact detection and rendering in side panel
      - Code artifact viewer with syntax highlighting
      - HTML/SVG preview with live rendering
      - React component preview
      - Mermaid diagram rendering
      - Text document artifacts
      - Artifact editing and re-prompting
      - Full-screen artifact view
      - Download artifact content
      - Artifact versioning and history
    </artifacts>

    <conversation_management>
      - Create new conversations
      - Conversation list in sidebar
      - Rename conversations
      - Delete conversations
      - Search conversations by title/content
      - Pin important conversations
      - Archive conversations
      - Conversation folders/organization
      - Duplicate conversation
      - Export conversation (JSON, Markdown, PDF)
      - Conversation timestamps (created, last updated)
      - Unread message indicators
    </conversation_management>

    <projects>
      - Create projects to group related conversations
      - Project knowledge base (upload documents)
      - Project-specific custom instructions
      - Share projects with team (mock feature)
      - Project settings and configuration
      - Move conversations between projects
      - Project templates
      - Project analytics (usage stats)
    </projects>

    <model_selection>
      - Model selector dropdown with the following models:
        - Claude Sonnet 4.5 (claude-sonnet-4-5-20250929) - default
        - Claude Haiku 4.5 (claude-haiku-4-5-20251001)
        - Claude Opus 4.1 (claude-opus-4-1-20250805)
      - Model capabilities display
      - Context window indicator
      - Model-specific pricing info (display only)
      - Switch models mid-conversation
      - Model comparison view
    </model_selection>

    <custom_instructions>
      - Global custom instructions
      - Project-specific custom instructions
      - Conversation-specific system prompts
      - Custom instruction templates
      - Preview how instructions affect responses
    </custom_instructions>

    <settings_preferences>
      - Theme selection (Light, Dark, Auto)
      - Font size adjustment
      - Message density (compact, comfortable, spacious)
      - Code theme selection
      - Language preferences
      - Accessibility options
      - Keyboard shortcuts reference
      - Data export options
      - Privacy settings
      - API key management
    </settings_preferences>

    <advanced_features>
      - Temperature control slider
      - Max tokens adjustment
      - Top-p (nucleus sampling) control
      - System prompt override
      - Thinking/reasoning mode toggle
      - Multi-modal input (text + images)
      - Voice input (optional, mock UI)
      - Response suggestions
      - Related prompts
      - Conversation branching
    </advanced_features>

    <collaboration>
      - Share conversation via link (read-only)
      - Export conversation formats
      - Conversation templates
      - Prompt library
      - Share artifacts
      - Team workspaces (mock UI)
    </collaboration>

    <search_discovery>
      - Search across all conversations
      - Filter by project, date, model
      - Prompt library with categories
      - Example conversations
      - Quick actions menu
      - Command palette (Cmd/Ctrl+K)
    </search_discovery>

    <usage_tracking>
      - Token usage display per message
      - Conversation cost estimation
      - Daily/monthly usage dashboard
      - Usage limits and warnings
      - API quota tracking
    </usage_tracking>

    <onboarding>
      - Welcome screen for new users
      - Feature tour highlights
      - Example prompts to get started
      - Quick tips and best practices
      - Keyboard shortcuts tutorial
    </onboarding>

    <accessibility>
      - Full keyboard navigation
      - Screen reader support
      - ARIA labels and roles
      - High contrast mode
      - Focus management
      - Reduced motion support
    </accessibility>

    <responsive_design>
      - Mobile-first responsive layout
      - Touch-optimized interface
      - Collapsible sidebar on mobile
      - Swipe gestures for navigation
      - Adaptive artifact display
      - Progressive Web App (PWA) support
    </responsive_design>
  </core_features>

  <database_schema>
    <description>
      InstantDB schema using entities and bidirectional links. No foreign key attributes -
      relationships are expressed through links. All fields used in where/order must be indexed.
    </description>
    <entities>
      <users>
        - id (auto-generated)
        - email: string, indexed, unique
        - name: string
        - avatarUrl: string, optional
        - createdAt: number, indexed (timestamp)
        - lastLogin: number, optional (timestamp)
        - preferences: object (theme, fontSize, messageDensity, codeTheme, language)
        - customInstructions: string, optional
      </users>

      <projects>
        - id (auto-generated)
        - name: string, indexed
        - description: string, optional
        - color: string
        - customInstructions: string, optional
        - knowledgeBasePath: string, optional
        - createdAt: number, indexed (timestamp)
        - updatedAt: number, indexed (timestamp)
        - isArchived: boolean, indexed
        - isPinned: boolean, indexed
      </projects>

      <conversations>
        - id (auto-generated)
        - title: string, indexed
        - model: string, indexed
        - createdAt: number, indexed (timestamp)
        - updatedAt: number, indexed (timestamp)
        - lastMessageAt: number, indexed (timestamp)
        - isArchived: boolean, indexed
        - isPinned: boolean, indexed
        - isDeleted: boolean, indexed
        - settings: object (temperature, maxTokens, topP, systemPrompt)
        - tokenCount: number
        - messageCount: number
      </conversations>

      <messages>
        - id (auto-generated)
        - role: string, indexed (user/assistant/system)
        - content: string
        - createdAt: number, indexed (timestamp)
        - editedAt: number, optional (timestamp)
        - tokens: number, optional
        - finishReason: string, optional
        - images: array of objects (url, alt, base64)
      </messages>

      <artifacts>
        - id (auto-generated)
        - type: string, indexed (code/html/svg/react/mermaid/text)
        - title: string, indexed
        - identifier: string, indexed, unique
        - language: string, optional
        - content: string
        - version: number, indexed
        - createdAt: number, indexed (timestamp)
        - updatedAt: number, indexed (timestamp)
      </artifacts>

      <sharedConversations>
        - id (auto-generated)
        - shareToken: string, indexed, unique
        - createdAt: number, indexed (timestamp)
        - expiresAt: number, indexed, optional (timestamp)
        - viewCount: number
        - isPublic: boolean, indexed
      </sharedConversations>

      <prompts>
        - id (auto-generated)
        - title: string, indexed
        - description: string, optional
        - promptTemplate: string
        - category: string, indexed
        - tags: array of strings
        - isPublic: boolean, indexed
        - usageCount: number, indexed
        - createdAt: number, indexed (timestamp)
        - updatedAt: number, indexed (timestamp)
      </prompts>

      <folders>
        - id (auto-generated)
        - name: string, indexed
        - position: number, indexed
        - createdAt: number, indexed (timestamp)
      </folders>

      <usageRecords>
        - id (auto-generated)
        - model: string, indexed
        - inputTokens: number
        - outputTokens: number
        - costEstimate: number
        - createdAt: number, indexed (timestamp)
      </usageRecords>

      <apiKeys>
        - id (auto-generated)
        - keyName: string, indexed
        - apiKeyHash: string
        - createdAt: number, indexed (timestamp)
        - lastUsedAt: number, optional (timestamp)
        - isActive: boolean, indexed
      </apiKeys>
    </entities>

    <links>
      <userProjects>
        - forward: { on: "projects", has: "many", label: "owner" }
        - reverse: { on: "users", has: "one", label: "projects" }
      </userProjects>

      <userConversations>
        - forward: { on: "conversations", has: "many", label: "owner" }
        - reverse: { on: "users", has: "one", label: "conversations" }
      </userConversations>

      <projectConversations>
        - forward: { on: "conversations", has: "many", label: "project" }
        - reverse: { on: "projects", has: "one", label: "conversations" }
      </projectConversations>

      <conversationMessages>
        - forward: { on: "messages", has: "many", label: "conversation" }
        - reverse: { on: "conversations", has: "one", label: "messages", onDelete: "cascade" }
      </conversationMessages>

      <messageParent>
        - forward: { on: "messages", has: "one", label: "parent", optional: true }
        - reverse: { on: "messages", has: "many", label: "branches" }
        - description: For conversation branching - a message can have a parent and multiple branch children
      </messageParent>

      <messageArtifacts>
        - forward: { on: "artifacts", has: "many", label: "message" }
        - reverse: { on: "messages", has: "one", label: "artifacts", onDelete: "cascade" }
      </messageArtifacts>

      <conversationArtifacts>
        - forward: { on: "artifacts", has: "many", label: "conversation" }
        - reverse: { on: "conversations", has: "one", label: "artifacts" }
        - description: Denormalized link for quick artifact lookup per conversation
      </conversationArtifacts>

      <conversationShare>
        - forward: { on: "sharedConversations", has: "one", label: "conversation", optional: true }
        - reverse: { on: "conversations", has: "one", label: "share", onDelete: "cascade" }
      </conversationShare>

      <userPrompts>
        - forward: { on: "prompts", has: "many", label: "author" }
        - reverse: { on: "users", has: "one", label: "prompts" }
      </userPrompts>

      <userFolders>
        - forward: { on: "folders", has: "many", label: "owner" }
        - reverse: { on: "users", has: "one", label: "folders" }
      </userFolders>

      <projectFolders>
        - forward: { on: "folders", has: "many", label: "project", optional: true }
        - reverse: { on: "projects", has: "one", label: "folders" }
      </projectFolders>

      <folderParent>
        - forward: { on: "folders", has: "one", label: "parent", optional: true }
        - reverse: { on: "folders", has: "many", label: "children" }
        - description: Nested folder hierarchy
      </folderParent>

      <folderConversations>
        - forward: { on: "conversations", has: "many", label: "folder" }
        - reverse: { on: "folders", has: "one", label: "conversations" }
      </folderConversations>

      <userUsageRecords>
        - forward: { on: "usageRecords", has: "many", label: "user" }
        - reverse: { on: "users", has: "one", label: "usageRecords" }
      </userUsageRecords>

      <conversationUsageRecords>
        - forward: { on: "usageRecords", has: "many", label: "conversation" }
        - reverse: { on: "conversations", has: "one", label: "usageRecords" }
      </conversationUsageRecords>

      <messageUsageRecord>
        - forward: { on: "usageRecords", has: "one", label: "message", optional: true }
        - reverse: { on: "messages", has: "one", label: "usageRecord" }
      </messageUsageRecord>

      <userApiKeys>
        - forward: { on: "apiKeys", has: "many", label: "owner" }
        - reverse: { on: "users", has: "one", label: "apiKeys" }
      </userApiKeys>
    </links>
  </database_schema>

  <data_layer>
    <description>
      InstantDB is a frontend database with real-time sync. Most data operations happen client-side
      using useQuery (InstaQL) for reads and transact (InstaML) for writes. Backend API routes are
      only needed for external services requiring API keys (Claude API) or server-side processing.
    </description>

    <frontend_queries>
      <description>
        React hooks using db.useQuery() for real-time data fetching. All queries auto-sync across clients.
        Use link traversal to fetch related data in a single query.
      </description>

      <authentication>
        - useQuery({ $users: { $: { where: { id: auth.id } } } }) - current user profile
        - db.auth.sendMagicCode(email) - initiate login
        - db.auth.signInWithMagicCode(email, code) - complete login
        - db.auth.signOut() - logout
      </authentication>

      <conversations>
        - useQuery({ conversations: { owner: {}, project: {}, messages: { artifacts: {} } } })
        - useQuery({ conversations: { $: { where: { isArchived: false }, order: { lastMessageAt: 'desc' } } } })
        - useQuery({ conversations: { $: { where: { id: conversationId } }, messages: { $: { order: { createdAt: 'asc' } } } } })
        - useQuery({ conversations: { $: { where: { 'project.id': projectId } } } })
        - useQuery({ conversations: { $: { where: { title: { $ilike: '%searchTerm%' } } } } })
      </conversations>

      <messages>
        - useQuery({ messages: { $: { where: { 'conversation.id': conversationId }, order: { createdAt: 'asc' } }, artifacts: {}, parent: {}, branches: {} } })
        - useQuery({ messages: { $: { where: { role: 'assistant' } }, artifacts: {} } })
      </messages>

      <artifacts>
        - useQuery({ artifacts: { $: { where: { 'conversation.id': conversationId } }, message: {} } })
        - useQuery({ artifacts: { $: { where: { identifier: artifactId } } } })
        - useQuery({ artifacts: { $: { where: { type: 'code' }, order: { version: 'desc' } } } })
      </artifacts>

      <projects>
        - useQuery({ projects: { $: { where: { isArchived: false }, order: { updatedAt: 'desc' } }, owner: {}, conversations: {}, folders: {} } })
        - useQuery({ projects: { $: { where: { id: projectId } }, conversations: { messages: {} } } })
      </projects>

      <sharing>
        - useQuery({ sharedConversations: { $: { where: { shareToken: token } }, conversation: { messages: { artifacts: {} } } } })
      </sharing>

      <prompts>
        - useQuery({ prompts: { $: { where: { isPublic: true }, order: { usageCount: 'desc' } }, author: {} } })
        - useQuery({ prompts: { $: { where: { category: categoryName } } } })
        - useQuery({ prompts: { $: { where: { 'author.id': userId } } } })
      </prompts>

      <folders>
        - useQuery({ folders: { $: { where: { 'owner.id': userId } }, parent: {}, children: {}, conversations: {}, project: {} } })
        - useQuery({ folders: { $: { where: { 'project.id': projectId }, order: { position: 'asc' } } } })
      </folders>

      <usage>
        - useQuery({ usageRecords: { $: { where: { 'user.id': userId, createdAt: { $gte: startOfDay } } } } })
        - useQuery({ usageRecords: { $: { where: { 'conversation.id': conversationId } }, message: {} } })
        - useQuery({ usageRecords: { $: { where: { model: modelName } } } })
      </usage>

      <settings>
        - useQuery({ $users: { $: { where: { id: auth.id } } } }) - includes preferences, customInstructions
        - useQuery({ apiKeys: { $: { where: { 'owner.id': userId, isActive: true } } } })
      </settings>
    </frontend_queries>

    <frontend_transactions>
      <description>
        Atomic writes using db.transact() with tx builder. All transactions sync in real-time.
        Use id() to generate IDs, .link() to create relationships.
      </description>

      <conversations>
        - tx.conversations[id()].create({ title, model, createdAt, settings }).link({ owner: userId, project: projectId })
        - tx.conversations[convId].update({ title, updatedAt })
        - tx.conversations[convId].update({ isArchived: true })
        - tx.conversations[convId].update({ isPinned: true })
        - tx.conversations[convId].delete()
        - tx.conversations[newId].create({ ...conversationData }).link({ owner: userId }) - duplicate
        - tx.messages[newMsgId].create({ ...messageData, parentMessageId }).link({ conversation: convId, parent: parentMsgId }) - branching
      </conversations>

      <messages>
        - tx.messages[id()].create({ role, content, createdAt }).link({ conversation: convId })
        - tx.messages[msgId].update({ content, editedAt })
        - tx.messages[msgId].delete()
      </messages>

      <artifacts>
        - tx.artifacts[id()].create({ type, title, identifier, content, version, createdAt }).link({ message: msgId, conversation: convId })
        - tx.artifacts[artifactId].update({ content, version, updatedAt })
        - tx.artifacts[artifactId].delete()
        - tx.artifacts[newId].create({ ...artifactData, version: newVersion }).link({ message: msgId }) - fork/version
      </artifacts>

      <projects>
        - tx.projects[id()].create({ name, description, color, createdAt }).link({ owner: userId })
        - tx.projects[projId].update({ name, description, customInstructions, updatedAt })
        - tx.projects[projId].update({ isArchived: true })
        - tx.projects[projId].delete()
        - tx.conversations[convId].link({ project: newProjectId }) - move conversation
      </projects>

      <sharing>
        - tx.sharedConversations[id()].create({ shareToken, createdAt, isPublic }).link({ conversation: convId })
        - tx.sharedConversations[shareId].update({ viewCount: viewCount + 1 })
        - tx.sharedConversations[shareId].update({ expiresAt, isPublic })
        - tx.sharedConversations[shareId].delete()
      </sharing>

      <prompts>
        - tx.prompts[id()].create({ title, description, promptTemplate, category, tags, createdAt }).link({ author: userId })
        - tx.prompts[promptId].update({ title, description, promptTemplate, updatedAt })
        - tx.prompts[promptId].update({ usageCount: usageCount + 1 })
        - tx.prompts[promptId].delete()
      </prompts>

      <folders>
        - tx.folders[id()].create({ name, position, createdAt }).link({ owner: userId, project: projectId, parent: parentFolderId })
        - tx.folders[folderId].update({ name, position })
        - tx.folders[folderId].delete()
        - tx.conversations[convId].link({ folder: folderId }) - add to folder
        - tx.conversations[convId].unlink({ folder: folderId }) - remove from folder
      </folders>

      <usage>
        - tx.usageRecords[id()].create({ model, inputTokens, outputTokens, costEstimate, createdAt }).link({ user: userId, conversation: convId, message: msgId })
      </usage>

      <settings>
        - tx.$users[userId].update({ preferences: { ...newPreferences } })
        - tx.$users[userId].update({ customInstructions })
        - tx.apiKeys[id()].create({ keyName, apiKeyHash, createdAt, isActive: true }).link({ owner: userId })
        - tx.apiKeys[keyId].update({ isActive: false })
        - tx.apiKeys[keyId].delete()
      </settings>
    </frontend_transactions>

    <presence>
      <description>
        Real-time presence for collaboration features using db.room() and usePresence hooks.
      </description>
      - room.publishPresence({ cursor, isTyping, activeArtifact }) - broadcast user state
      - usePresence(roomId) - subscribe to room presence updates
      - Typing indicators in conversations
      - Cursor position in shared artifact editing
      - Active user list in shared conversations
    </presence>

    <backend_trpc_procedures>
      <description>
        tRPC procedures served via NextJS /api/trpc/[trpc] route. Provides end-to-end
        type safety between frontend and backend. Only needed for operations requiring
        server-side processing, external API keys, or Trigger.dev task orchestration.
      </description>

      <router_structure>
        - appRouter (root)
          - claude: claudeRouter
          - export: exportRouter
          - tasks: tasksRouter
      </router_structure>

      <claude_router>
        - claude.chat (mutation)
          - Input: { messages, model, settings, conversationId }
          - Triggers Trigger.dev task for Claude API call
          - Writes messages/artifacts to InstantDB via admin SDK
          - Tracks usage and costs
          - Returns: { runId } for streaming subscription

        - claude.streamTokens (subscription)
          - Input: { runId }
          - SSE subscription to stream tokens from Trigger.dev run
          - Returns: AsyncIterable of token chunks

        - claude.models (query)
          - Returns: Array of available Claude models with capabilities

        - claude.uploadImage (mutation)
          - Input: { file: base64, mimeType, conversationId }
          - Handles image upload for multi-modal input
          - Returns: { imageUrl, imageId }
      </claude_router>

      <export_router>
        - export.conversation (mutation)
          - Input: { conversationId, format: 'json' | 'markdown' | 'pdf' }
          - Server-side PDF generation when needed
          - Returns: { downloadUrl } or { content } for JSON/markdown
      </export_router>

      <tasks_router>
        - tasks.getRunStatus (query)
          - Input: { runId }
          - Returns: Trigger.dev run status and metadata

        - tasks.cancelRun (mutation)
          - Input: { runId }
          - Cancels an in-progress Trigger.dev run (stop generation)
      </tasks_router>

      <trigger_dev_tasks>
        - claude-chat-completion: Long-running Claude API calls with streaming
        - artifact-generation: Process and validate artifact content
        - usage-aggregation: Scheduled task for daily/monthly usage rollups
        - cleanup-expired-shares: Cron job to remove expired shared conversations
      </trigger_dev_tasks>
    </backend_trpc_procedures>

    <permissions>
      <description>
        InstantDB permissions using CEL expressions. Define in instant.perms.ts.
      </description>

      <rules>
        - users: auth.id == data.id (users can only access their own profile)
        - projects: auth.id in data.ref('owner.id')
        - conversations: auth.id in data.ref('owner.id') || data.ref('share.isPublic') == true
        - messages: auth.id in data.ref('conversation.owner.id')
        - artifacts: auth.id in data.ref('conversation.owner.id')
        - sharedConversations: auth.id in data.ref('conversation.owner.id') || data.isPublic == true
        - prompts: auth.id in data.ref('author.id') || data.isPublic == true
        - folders: auth.id in data.ref('owner.id')
        - usageRecords: auth.id in data.ref('user.id')
        - apiKeys: auth.id in data.ref('owner.id')
      </rules>
    </permissions>
  </data_layer>

  <ui_layout>
    <main_structure>
      - Three-column layout: sidebar (conversations), main (chat), panel (artifacts)
      - Collapsible sidebar with resize handle
      - Responsive breakpoints: mobile (single column), tablet (two column), desktop (three column)
      - Persistent header with project/model selector
      - Bottom input area with send button and options
    </main_structure>

    <sidebar_left>
      - New chat button (prominent)
      - Project selector dropdown
      - Search conversations input
      - Conversations list (grouped by date: Today, Yesterday, Previous 7 days, etc.)
      - Folder tree view (collapsible)
      - Settings gear icon at bottom
      - User profile at bottom
    </sidebar_left>

    <main_chat_area>
      - Conversation title (editable inline)
      - Model selector badge
      - Message history (scrollable)
      - Welcome screen for new conversations
      - Suggested prompts (empty state)
      - Input area with formatting toolbar
      - Attachment button for images
      - Send button with loading state
      - Stop generation button
    </main_chat_area>

    <artifacts_panel>
      - Artifact header with title and type badge
      - Code editor or preview pane
      - Tabs for multiple artifacts
      - Full-screen toggle
      - Download button
      - Edit/Re-prompt button
      - Version selector
      - Close panel button
    </artifacts_panel>

    <modals_overlays>
      - Settings modal (tabbed interface)
      - Share conversation modal
      - Export options modal
      - Project settings modal
      - Prompt library modal
      - Command palette overlay
      - Keyboard shortcuts reference
    </modals_overlays>
  </ui_layout>

  <design_system>
    <color_palette>
      - Primary: Orange/amber accent (#CC785C claude-style)
      - Background: White (light mode), Dark gray (#1A1A1A dark mode)
      - Surface: Light gray (#F5F5F5 light), Darker gray (#2A2A2A dark)
      - Text: Near black (#1A1A1A light), Off-white (#E5E5E5 dark)
      - Borders: Light gray (#E5E5E5 light), Dark gray (#404040 dark)
      - Code blocks: Monaco editor theme
    </color_palette>

    <typography>
      - Sans-serif system font stack (Inter, SF Pro, Roboto, system-ui)
      - Headings: font-semibold
      - Body: font-normal, leading-relaxed
      - Code: Monospace (JetBrains Mono, Consolas, Monaco)
      - Message text: text-base (16px), comfortable line-height
    </typography>

    <components>
      <message_bubble>
        - User messages: Right-aligned, subtle background
        - Assistant messages: Left-aligned, no background
        - Markdown formatting with proper spacing
        - Inline code with bg-gray-100 background
        - Code blocks with syntax highlighting
        - Copy button on code blocks
      </message_bubble>

      <buttons>
        - Primary: Orange/amber background, white text, rounded
        - Secondary: Border style with hover fill
        - Icon buttons: Square with hover background
        - Disabled state: Reduced opacity, no pointer events
      </buttons>

      <inputs>
        - Rounded borders with focus ring
        - Textarea auto-resize
        - Placeholder text in gray
        - Error states in red
        - Character counter
      </inputs>

      <cards>
        - Subtle border or shadow
        - Rounded corners (8px)
        - Padding: p-4 to p-6
        - Hover state: slight shadow increase
      </cards>
    </components>

    <animations>
      - Smooth transitions (150-300ms)
      - Fade in for new messages
      - Slide in for sidebar
      - Typing indicator animation
      - Loading spinner for generation
      - Skeleton loaders for content
    </animations>
  </design_system>

  <key_interactions>
    <message_flow>
      1. User types message in input field
      2. Optional: Attach images via button
      3. Click send or press Enter
      4. Message appears in chat immediately
      5. Typing indicator shows while waiting
      6. Response streams in word by word
      7. Code blocks render with syntax highlighting
      8. Artifacts detected and rendered in side panel
      9. Message complete, enable regenerate option
    </message_flow>

    <artifact_flow>
      1. Assistant generates artifact in response
      2. Artifact panel slides in from right
      3. Content renders (code with highlighting or live preview)
      4. User can edit artifact inline
      5. "Re-prompt" button to iterate with Claude
      6. Download or copy artifact content
      7. Full-screen mode for detailed work
      8. Close panel to return to chat focus
    </artifact_flow>

    <conversation_management>
      1. Click "New Chat" to start fresh conversation
      2. Conversations auto-save with first message
      3. Auto-generate title from first exchange
      4. Click title to rename inline
      5. Drag conversations into folders
      6. Right-click for context menu (pin, archive, delete, export)
      7. Search filters conversations in real-time
      8. Click conversation to switch context
    </conversation_management>
  </key_interactions>

  <implementation_steps>
    <step number="1">
      <title>Setup Project Foundation and Database</title>
      <tasks>
        - Initialize InstantDB database and Trigger.dev project
        - Set up Claude API client with streaming support
        - Create database schema
        - Implement authentication
        - Set up basic tRPC router
        - Set up basic CORS and middleware
        - Create health check endpoint
      </tasks>
    </step>

    <step number="2">
      <title>Build Core Chat Interface</title>
      <tasks>
        - Create main layout with sidebar and chat area
        - Implement message display with markdown rendering
        - Add streaming message support with Trigger.dev, InstantDB
        - Build input area with auto-resize textarea
        - Add code block syntax highlighting
        - Implement stop generation functionality
        - Add typing indicators and loading states
      </tasks>
    </step>

    <step number="3">
      <title>Conversation Management</title>
      <tasks>
        - Create conversation list in sidebar
        - Implement new conversation creation
        - Add conversation switching
        - Build conversation rename functionality
        - Implement delete with confirmation
        - Add conversation search
        - Create conversation grouping by date
      </tasks>
    </step>

    <step number="4">
      <title>Artifacts System</title>
      <tasks>
        - Build artifact detection from Claude responses
        - Create artifact rendering panel
        - Implement code artifact viewer
        - Add HTML/SVG live preview
        - Build artifact editing interface
        - Add artifact versioning
        - Implement full-screen artifact view
      </tasks>
    </step>

    <step number="5">
      <title>Projects and Organization</title>
      <tasks>
        - Create projects CRUD queries and mutations
        - Build project selector UI
        - Implement project-specific custom instructions
        - Add folder system for conversations
        - Create drag-and-drop organization
        - Build project settings panel
      </tasks>
    </step>

    <step number="6">
      <title>Advanced Features</title>
      <tasks>
        - Add model selection dropdown
        - Implement temperature and parameter controls
        - Build image upload functionality
        - Create message editing and regeneration
        - Add conversation branching
        - Implement export functionality
      </tasks>
    </step>

    <step number="7">
      <title>Settings and Customization</title>
      <tasks>
        - Build settings modal with tabs
        - Implement theme switching (light/dark)
        - Add custom instructions management
        - Create keyboard shortcuts
        - Build prompt library
        - Add usage tracking dashboard
      </tasks>
    </step>

    <step number="8">
      <title>Sharing and Collaboration</title>
      <tasks>
        - Implement conversation sharing with tokens
        - Create public share view
        - Add export to multiple formats
        - Build prompt templates
        - Create example conversations
      </tasks>
    </step>

    <step number="9">
      <title>Polish and Optimization</title>
      <tasks>
        - Optimize for mobile responsiveness
        - Add command palette (Cmd+K)
        - Implement comprehensive keyboard navigation
        - Add onboarding flow
        - Create accessibility improvements
        - Performance optimization and caching
      </tasks>
    </step>
  </implementation_steps>

  <success_criteria>
    <functionality>
      - Streaming chat responses work smoothly
      - Artifact detection and rendering accurate
      - Conversation management intuitive and reliable
      - Project organization clear and useful
      - Image upload and display working
      - All CRUD operations functional
    </functionality>

    <user_experience>
      - Interface matches claude.ai design language
      - Responsive on all device sizes
      - Smooth animations and transitions
      - Fast response times and minimal lag
      - Intuitive navigation and workflows
      - Clear feedback for all actions
    </user_experience>

    <technical_quality>
      - Clean, maintainable code structure
      - Proper error handling throughout
      - Secure API key management
      - Optimized database queries
      - Efficient streaming implementation
      - Comprehensive testing coverage
    </technical_quality>

    <design_polish>
      - Consistent with claude.ai visual design
      - Beautiful typography and spacing
      - Smooth animations and micro-interactions
      - Excellent contrast and accessibility
      - Professional, polished appearance
      - Dark mode fully implemented
    </design_polish>
  </success_criteria>
</project_specification>